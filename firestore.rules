
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can read anyone's profile (for chat names/photos) but only write to their own.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth.uid == userId;

      // A professional can manage their own subcollections.
      match /{subcollection}/{docId} {
         allow read, write, delete: if request.auth.uid == userId && get(/databases/$(database)/documents/users/$(userId)).data.role == 'professional';
      }
    }
    
    // This rule allows a patient to list reports from any professional's subcollection
    // as long as the query filters for their own patientId.
    // It also allows a professional to read reports they created.
    match /users/{userId}/reports/{reportId} {
        allow read: if (request.auth != null && resource.data.patientId == request.auth.uid) || 
                       (request.auth.uid == userId);
    }

    // Chat participants can read/write messages in a chat.
    match /chats/{chatId}/messages/{messageId} {
      allow read, create: if request.auth != null && request.auth.uid in chatId.split('_');
    }
  }
}
