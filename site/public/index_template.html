<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha de Anamnese</title>
    <link rel="stylesheet" href="/site/public/css/estilo_pc.css">
    <link rel="stylesheet" href="/site/public/css/style.css">
    <style>
        @import url("/site/public/css/estilo_pc.css");
        /* Bottom navigation styles */
        footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100vw;
            background: #fff;
            box-shadow: 0 -4px 24px rgba(37,99,235,0.10), 0 -1px 8px rgba(0,0,0,0.06);
            z-index: 100;
            border-top-left-radius: 18px;
            border-top-right-radius: 18px;
            transition: box-shadow 0.2s;
        }

         .bottom-nav {
            display: flex;
            justify-content: space-evenly;
            height: 60px;
            align-items: center;
            padding: 14px 0 10px;
            gap: 8px;
        }

        .bottom-nav a {
            color: #2563eb;
            text-decoration: none;
            font-size: 1.08em;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            padding: 6px 18px 4px;
            border-radius: 10px;
            transition: 
            color 0.18s,
            background 0.18s,
            transform 0.15s,
            box-shadow 0.18s;
            position: relative;
        }

        .bottom-nav a:hover, .bottom-nav a:focus {
            color: #fff;
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            transform: translateY(-2px) scale(1.07);
            box-shadow: 0 4px 18px rgba(37,99,235,0.13);
            outline: none;
        }

        .bottom-nav a.active::after {
            content: '';
            display: block;
            margin: 6px auto 0;
            width: 22px;
            height: 3px;
            border-radius: 2px;
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
        }

        .bottom-nav i {
            font-size: 1.5em;
            transition: color 0.18s;
        }

        .bottom-nav span {
            font-size: 0.97em;
            letter-spacing: 0.01em;
        }

        /* Seus estilos de barra de progresso, botões de ação, e responsividade */
        #progress-bar-container {
            width: 100%;
            background: linear-gradient(90deg, #e3eafc 0%, #eaf1fb 100%);
            border-radius: 14px;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.10);
            height: 22px;
            position: relative;
            overflow: hidden;
        }

        #progress-bar {
            background: linear-gradient(90deg, #2563eb 0%, #3b82f6 40%, #60a5fa 80%, #a5d8ff 100%);
            height: 100%;
            width: 0%;
            border-radius: 14px 0 0 14px;
            box-shadow: 0 2px 12px rgba(37, 99, 235, 0.18);
            transition: width 0.5s cubic-bezier(.4,2,.6,1), background 0.3s;
            position: absolute;
            left: 0;
            top: 0;
        }

        #progress-bar::after {
            content: '';
            display: block;
            position: absolute;
            right: 0;
            top: 0;
            width: 22px;
            height: 100%;
            background: linear-gradient(90deg, rgba(255,255,255,0.45) 0%, rgba(96,165,250,0.18) 100%);
            border-radius: 0 14px 14px 0;
            opacity: 0.85;
            pointer-events: none;
        }

        #step-counter {
            text-align: center;
            margin-bottom: 28px;
            font-size: 1.08em;
            color: #2563eb;
            font-weight: 700;
            letter-spacing: 0.03em;
            text-shadow: 0 1px 0 #e3eafc;
        }

        .step {
            display: none;
        }

        .step.active {
            display: block;
            animation: fadeInStep 0.5s;
        }

        @keyframes fadeInStep {
            from { opacity: 0; transform: translateY(16px);}
            to { opacity: 1; transform: none;}
        }

        .action-buttons {
            margin-top: 28px;
            display: flex;
            gap: 14px;
            justify-content: space-between;
        }

        .action-buttons button {
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.08em;
            font-weight: 600;
            box-shadow: 0 2px 12px rgba(37,99,235,0.09);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
            outline: none;
        }
        
        #prevBtn {
            background: linear-gradient(90deg, #f44336 0%, #e57373 100%);
            color: #fff;
        }

        #prevBtn:hover, #prevBtn:focus {
            background: linear-gradient(90deg, #c62828 0%, #f44336 100%);
            color: #fff;
            box-shadow: 0 4px 16px rgba(244,67,54,0.18);
        }

        #nextBtn {
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            color: #fff;
        }

        #nextBtn:hover, #nextBtn:focus {
            background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
            box-shadow: 0 4px 16px rgba(37,99,235,0.18);
        }

        #submitBtn {
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            color: #fff;
            display: none;
        }

        #submitBtn:hover, #submitBtn:focus {
            background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
            box-shadow: 0 4px 16px rgba(37,99,235,0.18);
        }

        /* Custom message box styles */
        .message-box {
            position: fixed;
            top: 28px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 32px;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 1.08em;
            color: white;
            z-index: 1000;
            box-shadow: 0 6px 24px rgba(37,99,235,0.18), 0 2px 8px rgba(0,0,0,0.10);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, top 0.3s;
            pointer-events: none;
        }

        .message-box.success {
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
        }

        .message-box.error {
            background: linear-gradient(90deg, #f44336 0%, #e57373 100%);
        }

        /* Responsive improvements */
        @media (max-width: 600px) {
            #progress-bar-container {
                height: 14px;
                border-radius: 8px;
            }
            #progress-bar {
                border-radius: 8px 0 0 8px;
            }
            #progress-bar::after {
                border-radius: 0 8px 8px 0;
                width: 12px;
            }
            .action-buttons button {
                padding: 10px 12px;
                font-size: 0.98em;
            }
            .action-buttons {
                gap: 6px;
            }
        }

        /* New: Button to go back to dashboard */
        .back-to-dashboard-button {
            display: block;
            width: fit-content;
            margin: 20px auto;
            background-color: #6c757d; /* Gray for back button */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-to-dashboard-button:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<body>
    <h1>Ficha de Anamnese</h1>

    <div id="progress-bar-container">
        <div id="progress-bar"></div>
    </div>
    <div id="step-counter"></div>

    <div id="form-container">
        <form id="anamnese-form">
            <div class="step active">
                <fieldset>
                    <legend>Dados Pessoais</legend>
                    <div class="input-group">
                        <label for="nome_cliente">Nome do Cliente:</label>
                        <input type="text" id="nome_cliente" name="nome_cliente" placeholder="Nome Completo" required>
                    </div>
                    <div class="input-group">
                        <label for="data_nascimento">Data de Nascimento:</label>
                        <input type="date" id="data_nascimento" name="data_nascimento">
                    </div>
                    <div class="input-group">
                        <label for="telefone">Telefone:</label>
                        <input type="text" id="telefone" name="telefone" placeholder="Telefone">
                    </div>
                    <div class="input-group">
                        <label for="email">Email:</label>
                        <input type="email" id="email" name="email" placeholder="Email">
                    </div>
                    <div class="input-group">
                        <label for="profissao">Profissão:</label>
                        <input type="text" id="profissao" name="profissao" placeholder="Profissão">
                    </div>
                    <div class="input-group">
                        <label for="estado_civil">Estado Civil:</label>
                        <select id="estado_civil" name="estado_civil">
                            <option value="">Selecione</option>
                            <option value="Solteiro(a)">Solteiro(a)</option>
                            <option value="Casado(a)">Casado(a)</option>
                            <option value="Divorciado(a)">Divorciado(a)</option>
                            <option value="Viúvo(a)">Viúvo(a)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="nivel_atividade">Nível de Atividade/Mobilidade:</label>
                        <select id="nivel_atividade" name="nivel_atividade">
                            <option value="">Selecione</option>
                            <option value="acama">Acamado</option>
                            <option value="cadeira_rodas">Cadeira de Rodas</option>
                            <option value="deambulacao_limitada">Deambulação Limitada</option>
                            <option value="deambulacao_independente">Deambulacao Independente</option>
                            <option value="ativo">Ativo</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="suporte_social">Suporte Social:</label>
                        <textarea id="suporte_social" name="suporte_social"
                            placeholder="Descreva o suporte social e cuidadores"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="compreensao_adesao">Nível de Compreensão e Adesão ao Tratamento:</label>
                        <select id="compreensao_adesao" name="compreensao_adesao">
                            <option value="">Selecione</option>
                            <option value="boa">Boa</option>
                            <option value="regular">Regular</option>
                            <option value="baixa">Baixa</option>
                        </select>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Dados Clínicos</legend>
                    <div class="input-group">
                        <label for="objetivo_tratamento">Objetivo do Tratamento:</label>
                        <textarea id="objetivo_tratamento" name="objetivo_tratamento"
                            placeholder="Descreva o objetivo do tratamento"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="historico_cicatrizacao">Histórico de Cicatrização:</label>
                        <textarea id="historico_cicatrizacao" name="historico_cicatrizacao"
                            placeholder="Experiências anteriores de cicatrização"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="estado_nutricional">Avaliação do Estado Nutricional:</label>
                        <textarea id="estado_nutricional" name="estado_nutricional"
                            placeholder="Informações sobre alimentação, peso, etc."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="usa_medicacao">Usa Medicação:</label>
                        <select id="usa_medicacao" name="usa_medicacao">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="qual_medicacao">Qual Medicação:</label>
                        <input type="text" id="qual_medicacao" name="qual_medicacao" placeholder="Nome da medicação"
                            style="display: none;">
                    </div>
                    <div class="input-group">
                        <label for="possui_doenca">Possui Doença:</label>
                        <select id="possui_doenca" name="possui_doenca">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="qual_doenca">Qual Doença:</label>
                        <input type="text" id="qual_doenca" name="qual_doenca" placeholder="Nome da doença"
                            style="display: none;">
                    </div>
                    <div class="input-group">
                        <label for="possui_alergia">Possui Alergia:</label>
                        <select id="possui_alergia" name="possui_alergia">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="qual_alergia">Qual Alergia:</label>
                        <input type="text" id="qual_alergia" name="qual_alergia" placeholder="Tipo de alergia"
                            style="display: none;">
                    </div>
                    <div class="input-group">
                        <label for="pratica_atividade_fisica">Pratica Atividade Física:</label>
                        <select id="pratica_atividade_fisica" name="pratica_atividade_fisica">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="qual_atividade">Qual Atividade:</label>
                        <input type="text" id="qual_atividade" name="qual_atividade" placeholder="Tipo de atividade"
                            style="display: none;">
                    </div>
                    <div class="input-group">
                        <label for="frequencia_atividade">Frequência Atividade:</label>
                        <input type="text" id="frequencia_atividade" name="frequencia_atividade"
                            placeholder="Frequência da atividade" style="display: none;">
                    </div>
                    <div class="input-group">
                        <label for="ingestao_agua_dia">Ingestão Água/Dia:</label>
                        <input type="text" id="ingestao_agua_dia" name="ingestao_agua_dia"
                            placeholder="Quantidade de água por dia">
                    </div>
                    <div class="input-group">
                        <label for="ingestao_alcool">Ingestão Álcool:</label>
                        <select id="ingestao_alcool" name="ingestao_alcool">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="frequencia_alcool">Frequência Álcool:</label>
                        <input type="text" id="frequencia_alcool" name="frequencia_alcool"
                            placeholder="Frequência do consumo de álcool" style="display: none;">
                    </div>
               
                    <div class="input-group">
                        <label for="tem_filhos">Tem Filhos:</label>
                        <select id="tem_filhos" name="tem_filhos">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="quantos_filhos">Quantos Filhos:</label>
                        <input type="number" id="quantos_filhos" name="quantos_filhos" placeholder="Número de filhos"
                            style="display: none;">
                    </div>
                    <div class="input-group">
                        <label for="realizou_cirurgias">Realizou Cirurgias:</label>
                        <select id="realizou_cirurgias" name="realizou_cirurgias">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="quais_cirurgias">Quais Cirurgias:</label>
                        <input type="text" id="quais_cirurgias" name="quais_cirurgias" placeholder="Nome das cirurgias"
                            style="display: none;">
                    </div>
                    <div class="input-group" style="display: none;" id="funcao_vascular_group">
                        <label>Função Vascular:</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="claudicacao_intermitente" name="claudicacao_intermitente"
                                value="1">
                            <label for="claudicacao_intermitente">Claudicação Intermitente</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="dor_repouso" name="dor_repouso" value="1">
                            <label for="dor_repouso">Dor em Repouso</label>
                        </div>
                        <div class="input-group">
                            <label for="pulsos_perifericos">Pulsos Periféricos:</label>
                            <input type="text" id="pulsos_perifericos" name="pulsos_perifericos"
                                placeholder="Ex: Pedioso presente, Tibial posterior diminuído">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="fumante">Fumante:</label>
                        <select id="fumante" name="fumante">
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>
                </fieldset>
            </div>
            <script>
                // Exibe ou oculta campos de acordo com SIM/NÃO
                document.addEventListener('DOMContentLoaded', function () {
                    function toggleField(selectId, inputId) {
                        const select = document.getElementById(selectId);
                        const input = document.getElementById(inputId);
                        if (!select || !input) return;
                        function update() {
                            input.style.display = select.value === '1' ? 'block' : 'none';
                            if (select.value !== '1') input.value = '';
                        }
                        select.addEventListener('change', update);
                        update();
                    }
                    toggleField('usa_medicacao', 'qual_medicacao');
                    toggleField('possui_doenca', 'qual_doenca');
                    toggleField('possui_alergia', 'qual_alergia');
                    toggleField('pratica_atividade_fisica', 'qual_atividade');
                    toggleField('pratica_atividade_fisica', 'frequencia_atividade');
                    toggleField('ingestao_alcool', 'frequencia_alcool');
                    toggleField('tem_filhos', 'quantos_filhos');
                    toggleField('realizou_cirurgias', 'quais_cirurgias');
                });
            </script>

             <div class="step">
                <fieldset>
                    <legend>HPP e Comorbidades</legend>
                    <div class="checkbox-container">
                        <div class="checkbox-group">
                            <input type="checkbox" id="dmi" name="dmi" value="1">
                            <label for="dmi">DMI</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="dmii" name="dmii" value="1">
                            <label for="dmii">DMII</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="has" name="has" value="1">
                            <label for="has">HAS</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="neoplasia" name="neoplasia" value="1">
                            <label for="neoplasia">Neoplasia</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="hiv_aids" name="hiv_aids" value="1">
                            <label for="hiv_aids">HIV/SIDA</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="obesidade" name="obesidade" value="1">
                            <label for="obesidade">Obesidade</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="cardiopatia" name="cardiopatia" value="1">
                            <label for="cardiopatia">Cardiopatia</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="dpoc" name="dpoc" value="1">
                            <label for="dpoc">DPOC</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="doenca_hematologica" name="doenca_hematologica" value="1">
                            <label for="doenca_hematologica">Doença Hematológica</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="doenca_vascular" name="doenca_vascular" value="1">
                            <label for="doenca_vascular">Doença Vascular</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="demencia_senil" name="demencia_senil" value="1">
                            <label for="demencia_senil">Demência Senil</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="insuficiencia_renal" name="insuficiencia_renal" value="1">
                            <label for="insuficiencia_renal">Insuficiência renal</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="hanseniase" name="hanseniase" value="1">
                            <label for="hanseniase">Hanseníase</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="insuficiencia_hepatica" name="insuficiencia_hepatica" value="1">
                            <label for="insuficiencia_hepatica">Insuficiência Hepática</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="doenca_autoimune" name="doenca_autoimune" value="1">
                            <label for="doenca_autoimune">Doença Autoimune</label>
                        </div>
                        <br>
                        <div class="input-group">
                            <label for="outros_hpp">Outros:</label>
                            <input type="text" id="outros_hpp" name="outros_hpp" placeholder="Especifique...">
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Medicamento em uso</legend>
                    <div class="checkbox-container ">
                        <div class="checkbox-group">
                            <input type="checkbox" id="anti_hipertensivo" name="anti_hipertensivo" value="1">
                            <label for="anti_hipertensivo">Anti-hipertensivo</label>
                            <input type="text" name="anti_hipertensivo_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="corticoides" name="corticoides" value="1">
                            <label for="corticoides">Corticoides</label>
                            <input type="text" name="corticoides_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="hipoglicemiantes_orais" name="hipoglicemiantes_orais" value="1">
                            <label for="hipoglicemiantes_orais">Hipoglicemiantes orais</label>
                            <input type="text" name="hipoglicemiantes_orais_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="aines" name="aines" value="1">
                            <label for="aines">AINES</label>
                            <input type="text" name="aines_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="insulina" name="insulina" value="1">
                            <label for="insulina">Insulina UI/dia:</label>
                            <input type="text" name="insulina_dose" placeholder="Dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="drogas_vasoativa" name="drogas_vasoativa" value="1">
                            <label for="drogas_vasoativa">Drogas vasoativa</label>
                            <input type="text" name="drogas_vasoativa_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="suplemento" name="suplemento" value="1">
                            <label for="suplemento">Suplemento</label>
                            <input type="text" name="suplemento_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="anticoagulante" name="anticoagulante" value="1">
                            <label for="anticoagulante">Anticoagulante</label>
                            <input type="text" name="anticoagulante_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="vitaminico" name="vitaminico" value="1">
                            <label for="vitaminico">Vitamínico</label>
                            <input type="text" name="vitaminico_nome" placeholder="Nome edose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="antirretroviral" name="antirretroviral" value="1">
                            <label for="antirretroviral">Antirretroviral</label>
                            <input type="text" name="antirretroviral_nome" placeholder="Nome e dose"
                                style="display: block; margin-left: 20px;">
                        </div>
                        <div class="input-group">
                            <label for="outros_medicamento">Outros:</label>
                            <input type="text" id="outros_medicamento" name="outros_medicamento"
                                placeholder="Especifique...">
                        </div>
                    </div>
                </fieldset>

                </div>

            <div class="step">
                <fieldset>
                    <legend>Tamanho e Características da Ferida</legend>
                    <p>Capture ou insira manualmente as informações sobre a ferida do paciente.</p>

                    <div class="input-group">
                        <label for="foto_ferida">Foto da Ferida:</label>
                        <input type="file" id="foto_ferida" name="foto_ferida" accept="image/*" capture="environment"
                            style="display:none;">
                        <button type="button" class="photo-button" id="abrir-camera">
                            <i class="fas fa-camera"></i> Tirar/Selecionar Foto
                        </button>
                    </div>

                    <div class="photo-preview" style="margin-top:10px;">
                        <img id="photo-preview-img" src="" alt="Preview da foto"
                            style="display: none; max-width: 200px; border-radius: 8px;">
                        <p id="photo-preview-text" style="display: none;">Foto da ferida do paciente</p>
                        <button type="button" id="remover-foto" style="display:none; margin-top:5px;">Remover Foto <i
                                    class="fas fa-times"></i></button>
                    </div>

                    <div class="input-group" style="margin-top:15px;">
                        <label>Medidas da Ferida (cm):</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" step="0.1" min="0" name="ferida_largura" placeholder="Largura"
                                required>
                            <input type="number" step="0.1" min="0" name="ferida_comprimento" placeholder="Comprimento"
                                required>
                            <input type="number" step="0.1" min="0" name="ferida_profundidade" placeholder="Profundidade"
                                required>
                        </div>
                    </div>
                </fieldset>
                <script src="/site/public/js/foto_script.js"></script>

                <fieldset>
                    <legend>Avaliação da Ferida (TIMERS) - Parte 1</legend>
                    <p>Avalie as características da ferida utilizando a ferramenta TIMERS.</p>

                    <div class="input-group">
                        <label for="localizacao_ferida" style="font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-map-marker-alt" style="color:#333333"></i>
                            Localização Anatômica da Ferida:
                        </label>
                        <input type="text" id="localizacao_ferida" name="localizacao_ferida"
                            placeholder="Ex: Maléolo medial direito" required>
                    </div>

                    <div class="input-group">
                        <label for="etiologia_ferida" style="font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-question-circle" style="color:#333333"></i>
                            Etiologia da Ferida:
                        </label>
                        <select id="etiologia_ferida" name="etiologia_ferida" required>
                            <option value="">Selecione</option>
                            <option value="pressao">Pressão</option>
                            <option value="vascular_arterial">Vascular Arterial</option>
                            <option value="vascular_venosa">Vascular Venosa</option>
                            <option value="neuropatica">Neuropática</option>
                            <option value="traumatica">Traumática</option>
                            <option value="cirurgica">Cirúrgica</option>
                            <option value="queimadura">Queimadura</option>
                            <option value="outra">Outra</option>
                        </select>
                        <input type="text" id="etiologia_outra" name="etiologia_outra"
                            placeholder="Especificar outra etiologia" style="display: none; margin-top: 5px;">
                    </div>

                    <div class="input-group">
                        <label for="tempo_evolucao" style="font-weight: bold; font-size: 1.1em;">
                            <i class="fas fa-clock" style="color:#333333"></i>
                            Tempo de Evolução da Ferida:
                        </label>
                        <input type="text" id="tempo_evolucao" name="tempo_evolucao" placeholder="Ex: 3 semanas, 1 mês"
                            required>
                    </div>

                    <div class="input-group" style="margin-bottom: 2px;">
                        <label
                            style="font-weight: bold; font-size: 1.15em; display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <i class="fas fa-thermometer-half" style="color:#e67e22; font-size: 1.4em;"></i>
                            Intensidade da Dor <span style="font-size:0.95em; color:#888;">(Escala EVA 0-10)</span>
                        </label>
                        <div
                            style="display: flex; align-items: center; gap: 18px; flex-wrap: wrap; background: #fff8ef; border-radius: 10px; padding: 18px 16px 14px 16px; box-shadow: 0 2px 8px rgba(230,126,34,0.07);">
                            <input type="range" id="dor_escala" name="dor_escala" min="0" max="10" step="1"
                                style="width: 180px; accent-color: #14532d; height: 4px;"
                                oninput="updateEvaLabel(this.value)">
                            <span id="eva-value"
                                style="font-weight: bold; color: #14532d; font-size: 1.5em; margin-left: 8px; min-width: 32px; text-align: center;">0</span>
                            <span id="eva-label"
                                style="font-weight: 600; margin-left: 10px; font-size: 1.08em; color: #14532d;">Sem dor</span>
                            <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 5px; flex: 1 1 45px;">
                                <label for="dor_fatores"
                                    style="font-weight: 500; color: #2980b9; display: flex; align-items: center; gap: 6px; margin-bottom: 2px;">
                                    <i class="fas fa-info-circle"></i>
                                    Fatores que Aliviam/Pioram a Dor:
                                </label>
                                <input type="text" id="dor_fatores" name="dor_fatores"
                                    placeholder="Ex: Repouso alivia, deambulação piora"
                                    style="padding: 7px 12px; border: 1px solid #e1e4ea; border-radius: 6px; font-size: 1em; background: #f9fafb; margin-bottom: 0; margin-top: 0;">

                            </div>
                        </div>
                        <!-- Escala visual padronizada: linha única, texto só nos pares -->
                        <span style="color: #888; margin-top: 8px; display: block; font-size: 0.98em;">
                            <i class="fas fa-arrows-alt-h" style="color:#e67e22"></i>
                            Arraste para selecionar a intensidade da dor.
                        </span>
                     
                    </div>
                    <script>
                        // Escala EVA customizada: só muda texto nos pares, mantém cores
                        function updateEvaLabel(val) {
                            val = parseInt(val, 10);
                            const evaValue = document.getElementById('eva-value');
                            const evaLabel = document.getElementById('eva-label');
                            const range = document.getElementById('dor_escala');
                            let label = '';
                            let color = '';
                            let accent = '';
                            switch (val) {
                                case 0:
                                    label = 'Sem dor';
                                    color = '#14532d'; // verde escuro
                                    accent = '#14532d';
                                    break;
                                case 2:
                                    label = 'Dor leve';
                                    color = '#22c55e'; // verde claro
                                    accent = '#22c55e';
                                    break;
                                case 4:
                                    label = 'Moderada';
                                    color = '#eab308'; // amarelo
                                    accent = '#eab308';
                                    break;
                                case 6:
                                    label = 'Severa';
                                    color = '#fb923c'; // laranja
                                    accent = '#fb923c';
                                    break;
                                case 8:
                                    label = 'Dor muito severa';
                                    color = '#ef4444'; // vermelho
                                    accent = '#ef4444';
                                    break;
                                case 10:
                                    label = 'Pior dor possível';
                                    color = '#991b1b'; // vermelho escuro
                                    accent = '#991b1b';
                                    break;
                                default:
                                    label = '';
                                    // Cores intermediárias para impares
                                    if (val === 1)      { color = '#22c55e'; accent = '#22c55e'; label = 'Dor leve'; }
                                    else if (val === 3) { color = '#eab308'; accent = '#eab308'; label = 'Moderada'; }
                                    else if (val === 5) { color = '#fb923c'; accent = '#fb923c'; label = 'Severa'; }
                                    else if (val === 7) { color = '#ef4444'; accent = '#ef4444'; label = 'Muito severa'; }
                                    else if (val === 9) { color = '#991b1b'; accent = '#991b1b'; label = 'Pior dor possível'; }
                                    else                { color = '#14532d'; accent = '#14532d'; }
                            }
                            evaValue.textContent = val;
                            evaValue.style.color = color;
                            evaLabel.textContent = label;
                            evaLabel.style.color = color;
                            range.style.accentColor = accent;
                        }
                        // Inicializa ao carregar
                        document.addEventListener('DOMContentLoaded', function () {
                            updateEvaLabel(document.getElementById('dor_escala').value);
                        });
                    </script>
                </fieldset>
            </div>

            <div class="step">
                <fieldset>
                    <legend>Avaliação da Ferida (TIMERS) - Tecido e Inflamação</legend>
                    <p>Avalie as características da ferida utilizando a ferramenta TIMERS.</p>

                <div class="input-group">
                    <label style="color:#2563eb;">
                        <i class="fas fa-layer-group" style="font-size: 1.2em;"></i>
                        Percentual de Tecido no Leito da Ferida (%):
                    </label>
                    <style>
                        /* Escopo apenas para o campo de Percentual de Tecido */
                        #tecido_leito_group {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                            gap: 20px 28px;
                            margin-top: 14px;
                            background: linear-gradient(90deg, #e3eafc 0%, #eaf1fb 100%);
                            border-radius: 16px;
                            padding: 22px 16px 10px 16px;
                            box-shadow: 0 4px 18px rgba(37,99,235,0.08);
                        }
                        #tecido_leito_group .tecido-item {
                            display: flex;
                            flex-direction: column;
                            align-items: flex-start;
                            gap: 6px;
                        }
                        #tecido_leito_group .tecido-label {
                            font-weight: 600;
                            display: flex;
                            align-items: center;
                            gap: 7px;
                        }
                        #tecido_leito_group .tecido-label.epitelizacao { color: #27ae60; }
                        #tecido_leito_group .tecido-label.granulacao { color: #e67e22; }
                        #tecido_leito_group .tecido-label.necrose-seca { color: #7f8c8d; }
                        #tecido_leito_group .tecido-label.necrose-umida { color: #2980b9; }
                        #tecido_leito_group .tecido-label.muscular { color: #c0392b; }
                        #tecido_leito_group .tecido-label.tendinoso { color: #8e44ad; }
                        #tecido_leito_group .tecido-label.osseo { color: #f39c12; }
                        #tecido_leito_group .tecido-label.sem-visivel { color: #34495e; }
                        #tecido_leito_group .tecido-input-wrapper {
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            width: 100%;
                        }
                        #tecido_leito_group .tecido-input[type="range"] {
                            flex: 1 1 120px;
                            height: 8px;
                            border-radius: 4px;
                            appearance: none;
                            -webkit-appearance: none;
                            background: #d3d3d3;
                            outline: none;
                            opacity: 0.7;
                            transition: opacity .2s;
                            min-width: 0;
                        }
                        #tecido_leito_group .tecido-input[type="range"]:hover {
                            opacity: 1;
                        }
                        #tecido_leito_group .tecido-input[type="range"]::-webkit-slider-thumb {
                            -webkit-appearance: none;
                            appearance: none;
                            width: 18px;
                            height: 18px;
                            border-radius: 50%;
                            background: var(--accent-color, #2563eb);
                            cursor: pointer;
                            border: 1px solid #fff;
                            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
                            margin-top: -5px;
                        }
                        #tecido_leito_group .tecido-input[type="range"]::-moz-range-thumb {
                            width: 18px;
                            height: 18px;
                            border-radius: 50%;
                            background: var(--accent-color, #2563eb);
                            cursor: pointer;
                            border: 1px solid #fff;
                            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
                        }
                        #tecido_leito_group .tecido-value {
                            min-width: 38px;
                            font-weight: 600;
                        }
                        #tecido_leito_group .info-message {
                            color: #2563eb;
                            margin-top: 12px;
                            display: block;
                            font-size: 1.01em;
                            font-weight: 500;
                        }
                        /* Label do grupo */
                        #tecido_leito_group_label {
                            font-weight: bold;
                            font-size: 1.13em;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                            margin-bottom: 8px;
                        }

                        /* BARRA DE PROGRESSO DO PERCENTUAL DE TECIDO */
                        .tecido-progress-bar-container {
                            width: 100%;
                            height: 18px;
                            background: #e3eafc;
                            border-radius: 8px;
                            margin: 18px 0 8px 0;
                            overflow: hidden;
                            box-shadow: 0 2px 8px rgba(37,99,235,0.08);
                            display: flex;
                        }
                        .tecido-progress-bar-segment {
                            height: 100%;
                            transition: width 0.4s cubic-bezier(.4,2,.6,1);
                        }
                        .tecido-progress-epitelizacao { background: #27ae60; }
                        .tecido-progress-granulacao { background: #e67e22; }
                        .tecido-progress-necrose-seca { background: #7f8c8d; }
                        .tecido-progress-necrose-umida { background: #2980b9; }
                        .tecido-progress-muscular { background: #c0392b; }
                        .tecido-progress-tendinoso { background: #8e44ad; }
                        .tecido-progress-osseo { background: #f39c12; }
                        .tecido-progress-sem-visivel { background: #34495e; }

                        /* Responsivo barra de progresso */
                        @media (max-width: 900px) {
                            #tecido_leito_group {
                                grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
                                gap: 14px 12px;
                                padding: 16px 8px 8px 8px;
                            }
                            #tecido_leito_group .tecido-label {
                                font-size: 0.98em;
                            }
                            .tecido-progress-bar-container {
                                height: 14px;
                            }
                        }
                        @media (max-width: 600px) {
                            #tecido_leito_group {
                                grid-template-columns: 1fr;
                                gap: 10px 0;
                                padding: 10px 4px 6px 4px;
                            }
                            #tecido_leito_group .tecido-item {
                                gap: 2px;
                            }
                            #tecido_leito_group .tecido-label {
                                font-size: 0.97em;
                            }
                            #tecido_leito_group .tecido-input-wrapper {
                                gap: 6px;
                            }
                            #tecido_leito_group .tecido-input[type="range"] {
                                height: 6px;
                            }
                            #tecido_leito_group .tecido-value {
                                font-size: 0.97em;
                                min-width: 30px;
                            }
                            .tecido-progress-bar-container {
                                height: 10px;
                            }
                        }
                    </style>

                    <!-- Barra de Progresso Visual dos Percentuais -->
                    <div class="tecido-progress-bar-container" id="tecido-progress-bar">
                        <div class="tecido-progress-bar-segment tecido-progress-epitelizacao" style="width:0%"></div>
                        <div class="tecido-progress-bar-segment tecido-progress-granulacao" style="width:0%"></div>
                        <div class="tecido-progress-bar-segment tecido-progress-necrose-seca" style="width:0%"></div>
                        <div class="tecido-progress-bar-segment tecido-progress-necrose-umida" style="width:0%"></div>
                        <div class="tecido-progress-bar-segment tecido-progress-muscular" style="width:0%"></div>
                        <div class="tecido-progress-bar-segment tecido-progress-tendinoso" style="width:0%"></div>
                        <div class="tecido-progress-bar-segment tecido-progress-osseo" style="width:0%"></div>
                        <div class="tecido-progress-bar-segment tecido-progress-sem-visivel" style="width:0%"></div>
                    </div>
                    <div style="font-size:0.98em; margin-bottom: 8px; color:#444;">
                        <b>Base de cálculo:</b> O percentual de cada tecido é estimado visualmente sobre o <b>leito total da ferida</b> (100%).<br>
                        <span style="display:inline-block;margin-top:4px;">
                            <span style="display:inline-block;width:14px;height:14px;background:#27ae60;border-radius:3px;margin-right:4px;vertical-align:middle;"></span> Epitelização
                            <span style="display:inline-block;width:14px;height:14px;background:#e67e22;border-radius:3px;margin:0 4px 0 12px;vertical-align:middle;"></span> Granulação
                            <span style="display:inline-block;width:14px;height:14px;background:#7f8c8d;border-radius:3px;margin:0 4px 0 12px;vertical-align:middle;"></span> Necrose Seca
                            <span style="display:inline-block;width:14px;height:14px;background:#2980b9;border-radius:3px;margin:0 4px 0 12px;vertical-align:middle;"></span> Necrose Úmida
                            <span style="display:inline-block;width:14px;height:14px;background:#c0392b;border-radius:3px;margin:0 4px 0 12px;vertical-align:middle;"></span> Muscular
                            <span style="display:inline-block;width:14px;height:14px;background:#8e44ad;border-radius:3px;margin:0 4px 0 12px;vertical-align:middle;"></span> Tendinoso
                            <span style="display:inline-block;width:14px;height:14px;background:#f39c12;border-radius:3px;margin:0 4px 0 12px;vertical-align:middle;"></span> Ósseo
                            <span style="display:inline-block;width:14px;height:14px;background:#34495e;border-radius:3px;margin:0 4px 0 12px;vertical-align:middle;"></span> Sem visível
                        </span>
                    </div>

                    <div id="tecido_leito_group">

                        <div class="tecido-item">
                            <label for="percentual_epitelizacao_leito" class="tecido-label epitelizacao">
                                <i class="fas fa-layer-group"></i>
                                Epitelização
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_epitelizacao_leito"
                                    name="percentual_epitelizacao_leito" min="0" max="100" value="0"
                                    class="tecido-input"
                                    style="accent-color: #27ae60;"
                                    required
                                    oninput="document.getElementById('percentual_epitelizacao_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_epitelizacao_leito_val_range" class="tecido-value" style="color: #27ae60;">0%</span>
                            </div>
                        </div>

                        <div class="tecido-item">
                            <label for="percentual_granulacao_leito" class="tecido-label granulacao">
                                <i class="fas fa-seedling"></i>
                                Granulação
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_granulacao_leito"
                                    name="percentual_granulacao_leito" min="0" max="100" value="0"
                                    class="tecido-input"
                                    style="accent-color: #e67e22;"
                                    required
                                    oninput="document.getElementById('percentual_granulacao_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_granulacao_leito_val_range" class="tecido-value" style="color: #e67e22;">0%</span>
                            </div>
                        </div>

                        <div class="tecido-item">
                            <label for="percentual_necrose_seca_leito" class="tecido-label necrose-seca">
                                <i class="fas fa-burn"></i>
                                Necrose Seca (Escara)
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_necrose_seca_leito"
                                    name="percentual_necrose_seca_leito" min="0" max="100" value="0"
                                    class="tecido-input"
                                    style="accent-color: #7f8c8d;"
                                    required
                                    oninput="document.getElementById('percentual_necrose_seca_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_necrose_seca_leito_val_range" class="tecido-value" style="color: #7f8c8d;">0%</span>
                            </div>
                        </div>

                        <div class="tecido-item">
                            <label for="percentual_necrose_umida_leito" class="tecido-label necrose-umida">
                                <i class="fas fa-tint"></i>
                                Necrose Úmida
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_necrose_umida_leito"
                                    name="percentual_necrose_umida_leito" min="0" max="100" value="0"
                                    class="tecido-input"
                                    style="accent-color: #2980b9;"
                                    required
                                    oninput="document.getElementById('percentual_necrose_umida_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_necrose_umida_leito_val_range" class="tecido-value" style="color: #2980b9;">0%</span>
                            </div>
                        </div>

                        <div class="tecido-item">
                            <label for="percentual_muscular_leito" class="tecido-label muscular">
                                <i class="fas fa-dumbbell"></i>
                                Tecido Muscular Exposto
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_muscular_leito" name="percentual_muscular_leito"
                                    min="0" max="100" value="0" class="tecido-input"
                                    style="accent-color: #c0392b;"
                                    required
                                    oninput="document.getElementById('percentual_muscular_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_muscular_leito_val_range" class="tecido-value" style="color: #c0392b;">0%</span>
                            </div>
                        </div>

                        <div class="tecido-item">
                            <label for="percentual_tendinoso_leito" class="tecido-label tendinoso">
                                <i class="fas fa-link"></i>
                                Tecido Tendinoso Exposto
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_tendinoso_leito" name="percentual_tendinoso_leito"
                                    min="0" max="100" value="0" class="tecido-input"
                                    style="accent-color: #8e44ad;"
                                    required
                                    oninput="document.getElementById('percentual_tendinoso_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_tendinoso_leito_val_range" class="tecido-value" style="color: #8e44ad;">0%</span>
                            </div>
                        </div>

                        <div class="tecido-item">
                            <label for="percentual_osseo_leito" class="tecido-label osseo">
                                <i class="fas fa-bone"></i>
                                Tecido Ósseo Exposto
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_osseo_leito" name="percentual_osseo_leito" min="0"
                                    max="100" value="0" class="tecido-input"
                                    style="accent-color: #f39c12;"
                                    required
                                    oninput="document.getElementById('percentual_osseo_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_osseo_leito_val_range" class="tecido-value" style="color: #f39c12;">0%</span>
                            </div>
                        </div>

                        <div class="tecido-item">
                            <label for="percentual_sem_visivel_leito" class="tecido-label sem-visivel">
                                <i class="fas fa-eye-slash"></i>
                                Sem Tecido Visível
                            </label>
                            <div class="tecido-input-wrapper">
                                <input type="range" id="percentual_sem_visivel_leito"
                                    name="percentual_sem_visivel_leito" min="0" max="100" value="0"
                                    class="tecido-input"
                                    style="accent-color: #34495e;"
                                    required
                                    oninput="document.getElementById('percentual_sem_visivel_leito_val_range').textContent = this.value + '%'">
                                <span id="percentual_sem_visivel_leito_val_range" class="tecido-value" style="color: #34495e;">0%</span>
                            </div>
                        </div>

                    </div>
                    <small class="info-message">
                        <i class="fas fa-info-circle"></i>
                        Informe o percentual aproximado de cada tipo de tecido presente no leito da ferida. A soma deve ser 100%.
                    </small>
                </div>

                <script>
                document.addEventListener('DOMContentLoaded', function () {
                    const tecidoIds = [
                        'percentual_epitelizacao_leito',
                        'percentual_granulacao_leito',
                        'percentual_necrose_seca_leito',
                        'percentual_necrose_umida_leito',
                        'percentual_muscular_leito',
                        'percentual_tendinoso_leito',
                        'percentual_osseo_leito',
                        'percentual_sem_visivel_leito'
                    ];
                    const progressClasses = [
                        'tecido-progress-epitelizacao',
                        'tecido-progress-granulacao',
                        'tecido-progress-necrose-seca',
                        'tecido-progress-necrose-umida',
                        'tecido-progress-muscular',
                        'tecido-progress-tendinoso',
                        'tecido-progress-osseo',
                        'tecido-progress-sem-visivel'
                    ];
                    const tecidoInputs = tecidoIds.map(id => document.getElementById(id));
                    const progressBar = document.getElementById('tecido-progress-bar');
                    const progressSegments = Array.from(progressBar.children);

                    function updateProgressBar() {
                        let total = 0;
                        tecidoInputs.forEach((input, idx) => {
                            const val = parseInt(input.value, 10) || 0;
                            progressSegments[idx].style.width = val + '%';
                            total += val;
                        });
                        // Visual feedback: green border if sum == 100, red otherwise
                        tecidoInputs.forEach(el => {
                            const parentDiv = el.closest('.tecido-item');
                            if (parentDiv) {
                                parentDiv.style.boxShadow = (total === 100)
                                    ? '0 0 0 2px #27ae60'
                                    : '0 0 0 2px #e74c3c';
                            }
                        });
                    }

                    tecidoInputs.forEach((input, idx) => {
                        input.addEventListener('input', function () {
                            // Update the span text for the current input
                            const valSpan = document.getElementById(this.id + '_val_range');
                            if (valSpan) valSpan.textContent = this.value + '%';

                            // If the current value is 100, set others to 0
                            if (parseInt(this.value, 10) === 100) {
                                tecidoInputs.forEach((otherInput, otherIdx) => {
                                    if (otherIdx !== idx) {
                                        otherInput.value = 0;
                                        const otherValSpan = document.getElementById(otherInput.id + '_val_range');
                                        if (otherValSpan) otherValSpan.textContent = '0%';
                                    }
                                });
                            }
                            updateProgressBar();
                        });
                    });

                    // Inicializa barra ao carregar
                    updateProgressBar();
                });
                </script>
                    <div class="input-group">
                        <label
                            style="font-weight: bold; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-exclamation-circle" style="color:#e67e22"></i>
                            Sinais de Inflamação:
                        </label>
                        <div class="checkbox-container"
                            style="display: flex; flex-wrap: wrap; gap: 18px 32px; margin-top: 10px;">
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="inflamacao_rubor" name="inflamacao_rubor" value="1">
                                <label for="inflamacao_rubor">
                                    <i class="fas fa-tint" style="color:#e74c3c"></i>
                                    <span style="margin-left: 6px;">Rubor <span
                                            style="color:#888; font-size:0.95em;">(Vermelhidão)</span></span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="inflamacao_calor" name="inflamacao_calor" value="1">
                                <label for="inflamacao_calor">
                                    <i class="fas fa-fire" style="color:#e67e22"></i>
                                    <span style="margin-left: 6px;">Calor</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="inflamacao_edema" name="inflamacao_edema" value="1">
                                <label for="inflamacao_edema">
                                    <i class="fas fa-water" style="color:#3498db"></i>
                                    <span style="margin-left: 6px;">Edema <span
                                            style="color:#888; font-size:0.95em;">(Inchaço)</span></span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="inflamacao_dor_local" name="inflamacao_dor_local" value="1">
                                <label for="inflamacao_dor_local">
                                    <i class="fas fa-bolt" style="color:#f1c40f"></i>
                                    <span style="margin-left: 6px;">Dor Local</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="inflamacao_perda_funcao" name="inflamacao_perda_funcao"
                                    value="1">
                                <label for="inflamacao_perda_funcao">
                                    <i class="fas fa-ban" style="color:#7f8c8d"></i>
                                    <span style="margin-left: 6px;">Perda de Função</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Avaliação da Ferida (TIMERS) - Infecção e Exsudato</legend>
                    <p>Avalie as características da ferida utilizando a ferramenta TIMERS.</p>

                    <div class="input-group">
                        <label
                            style="font-weight: bold; font-size: 1.1em; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-exclamation-triangle" style="color:#c0392b"></i>
                            Sinais de Infecção Local:
                        </label>
                        <div class="checkbox-container"
                            style="display: flex; flex-wrap: wrap; gap: 18px 32px; margin-top: 10px;">
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="infeccao_eritema_perilesional"
                                    name="infeccao_eritema_perilesional" value="1">
                                <label for="infeccao_eritema_perilesional">
                                    <i class="fas fa-tint" style="color:#e74c3c"></i>
                                    <span style="margin-left: 6px;">Eritema Perilesional</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="infeccao_calor_local" name="infeccao_calor_local" value="1">
                                <label for="infeccao_calor_local">
                                    <i class="fas fa-fire" style="color:#e67e22"></i>
                                    <span style="margin-left: 6px;">Calor Local</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px">
                                <input type="checkbox" id="infeccao_edema" name="infeccao_edema" value="1">
                                <label for="infeccao_edema">
                                    <i class="fas fa-water" style="color:#3498db"></i>
                                    <span style="margin-left: 6px;">Edema</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px">
                                <input type="checkbox" id="infeccao_dor_local" name="infeccao_dor_local" value="1">
                                <label for="infeccao_dor_local">
                                    <i class="fas fa-bolt" style="color:#f1c40f"></i>
                                    <span style="margin-left: 6px;">Dor Local</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="infeccao_exsudato" name="infeccao_exsudato" value="1">
                                <label for="infeccao_exsudato">
                                    <i class="fas fa-vial" style="color:#f39c12"></i>
                                    <span style="margin-left: 6px;">Exsudato Purulento</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px">
                                <input type="checkbox" id="infeccao_odor" name="infeccao_odor" value="1">
                                <label for="infeccao_odor">
                                    <i class="fas fa-wind" style="color:#8e44ad"></i>
                                    <span style="margin-left: 6px;">Odor Fétido</span>
                                </label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px">
                                <input type="checkbox" id="infeccao_retardo_cicatrizacao"
                                    name="infeccao_retardo_cicatrizacao" value="1">
                                <label for="infeccao_retardo_cicatrizacao">
                                    <i class="fas fa-hourglass-half" style="color:#7f8c8d"></i>
                                    <span style="margin-left: 6px;">Retardo na Cicatrização</span>
                                </label>
                            </div>
                        </div>
                    </div>


                    <div class="input-group">
                        <label for="cultura_realizada">Cultura da Ferida Realizada?</label>
                        <select id="cultura_realizada" name="cultura_realizada" required>
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>

                    <div class="input-group" id="resultado_cultura_group" style="display: none;">
                        <label for="resultado_cultura">Resultado da Cultura (se realizada):</label>
                        <input type="text" id="resultado_cultura" name="resultado_cultura"
                            placeholder="Microrganismos identificados">
                    </div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            const culturaSelect = document.getElementById('cultura_realizada');
                            const resultadoGroup = document.getElementById('resultado_cultura_group');
                            const resultadoInput = document.getElementById('resultado_cultura');
                            function toggleResultadoCultura() {
                                if (culturaSelect.value === '1') {
                                    resultadoGroup.style.display = 'block';
                                } else {
                                    resultadoGroup.style.display = 'none';
                                    resultadoInput.value = '';
                                }
                            }
                            culturaSelect.addEventListener('change', toggleResultadoCultura);
                            toggleResultadoCultura();
                        });
                    </script>
                </fieldset>

                <fieldset>
                    <legend>Avaliação da Ferida (TIMERS) - Exsudato e Pele Perilesional</legend>
                    <p>Avalie as características da ferida utilizando a ferramenta TIMERS.</p>

                    <div class="input-group">
                        <label for="quantidade_exsudato">
                            <i class="fas fa-tint"></i> Quantidade de Exsudato:
                        </label>
                        <select id="quantidade_exsudato" name="quantidade_exsudato" required>
                            <option value="">Selecione</option>
                            <option value="ausente">&#10006; Ausente</option>
                            <option value="escasso">&#128167; Escasso</option>
                            <option value="minimo">&#128167;&#128167; Mínimo</option>
                            <option value="moderado">&#128167;&#128167;&#128167; Moderado</option>
                            <option value="abundante">&#128167;&#128167;&#128167;&#128167; Abundante</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="tipo_exsudato">
                            <i class="fas fa-vial"></i> Tipo de Exsudato:
                        </label>
                        <select id="tipo_exsudato" name="tipo_exsudato" required>
                            <option value="">Selecione</option>
                            <option value="seroso">Seroso (Claro, aquoso)</option>
                            <option value="sanguinolento">Sanguinolento (Vermelho)</option>
                            <option value="serossanguinolento">Serossanguinolento (Claro com sangue)</option>
                            <option value="purulento">Purulento (Amarelo, verde, turvo)</option>
                            <option value="purulento_foul">Purulento com Odor Fétido</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="consistencia_exsudato">Consistência do Exsudato:</label>
                        <select id="consistencia_exsudato" name="consistencia_exsudato" required>
                            <option value="">Selecione</option>
                            <option value="fina">Fina/Fluida</option>
                            <option value="viscosa">Viscosa</option>
                            <option value="espessa">Espessa</option>
                            <option value="gelatinosa">Gelatinosa</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="pele_perilesional_umidade">Pele Perilesional (Umidade):</label>
                        <select id="pele_perilesional_umidade" name="pele_perilesional_umidade" required>
                            <option value="">Selecione</option>
                            <option value="seca">Seca</option>
                            <option value="hidratada">Hidratada</option>
                            <option value="macerada">Macerada</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="pele_perilesional_extensao">Extensão da Alteração Perilesional:</label>
                        <input type="text" id="pele_perilesional_extensao" name="pele_perilesional_extensao"
                            placeholder="Ex: 2 cm ao redor da borda">
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Avaliação da Ferida (TIMERS) - Bordas e Cicatrização</legend>
                    <p>Avalie as características da ferida utilizando a ferramenta TIMERS.</p>

                    <div class="input-group">
                        <label for="bordas_caracteristicas">Características das Bordas da Ferida:</label>
                        <select id="bordas_caracteristicas" name="bordas_caracteristicas" required>
                            <option value="">Selecione</option>
                            <option value="regulares">Regulares</option>
                            <option value="irregulares">Irregulares</option>
                            <option value="aderidas">Aderidas</option>
                            <option value="descoladas">Descoladas</option>
                            <option value="hiperqueratosicas">Hiperqueratóticas</option>
                            <option value="fibroticas">Fibroticas</option>
                            <option value="erosao">Com Erosão</option>
                            <option value="induradas">Induradas</option>
                            <option value="em_tunel">Em Túnel</option>
                            <option value="roladas">Roladas</option>
                            <option value="bem_definidas">Bem Definidas</option>
                            <option value="mal_definidas">Mal Definidas</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="fixacao_bordas">Fixação das Bordas ao Leito:</label>
                        <select id="fixacao_bordas" name="fixacao_bordas" required>
                            <option value="">Selecione</option>
                            <option value="aderidas">Aderidas</option>
                            <option value="nao_aderidas">Não Aderidas</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label for="tunel_cavidade">Presença de Túneis ou Cavidade?</label>
                        <select id="tunel_cavidade" name="tunel_cavidade" required>
                            <option value="0">Não</option>
                            <option value="1">Sim</option>
                        </select>
                    </div>

                    <div class="input-group" id="localizacao_tunel_cavidade_group" style="display: none;">
                        <label for="localizacao_tunel_cavidade">Localização dos Túneis/Cavidade (se presente):</label>
                        <input type="text" id="localizacao_tunel_cavidade" name="localizacao_tunel_cavidade"
                            placeholder="Ex: 12 horas, 3 cm de profundidade">
                    </div>
                    <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const tunelSelect = document.getElementById('tunel_cavidade');
                        const localizacaoGroup = document.getElementById('localizacao_tunel_cavidade_group');
                        const localizacaoInput = document.getElementById('localizacao_tunel_cavidade');
                        function toggleLocalizacaoTunel() {
                            if (tunelSelect.value === '1') {
                                localizacaoGroup.style.display = 'block';
                            } else {
                                localizacaoGroup.style.display = 'none';
                                localizacaoInput.value = '';
                            }
                        }
                        tunelSelect.addEventListener('change', toggleLocalizacaoTunel);
                        toggleLocalizacaoTunel();
                    });
                    </script>

                    <div class="input-group">
                        <label for="velocidade_cicatrizacao">Velocidade de Cicatrização Observada:</label>
                        <select id="velocidade_cicatrizacao" name="velocidade_cicatrizacao" required>
                            <option value="">Selecione</option>
                            <option value="rapida">Rápida</option>
                            <option value="lenta">Lenta</option>
                            <option value="estagnada">Estagnada</option>
                            <option value="regredindo">Regredindo</option>
                        </select>
                    </div>


                    <div class="input-group">
                        <label style="font-weight: bold; font-size: 1.1em;">Condição da Pele Perilesional:</label>
                        <div class="checkbox-container" style="display: flex; flex-wrap: wrap; gap: 18px 32px; margin-top: 10px;">
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_integra" name="pele_perilesional_integra" value="1">
                                <label for="pele_perilesional_integra">Íntegra</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_eritematosa" name="pele_perilesional_eritematosa" value="1">
                                <label for="pele_perilesional_eritematosa">Eritematosa (Vermelha)</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_macerada" name="pele_perilesional_macerada" value="1">
                                <label for="pele_perilesional_macerada">Macerada</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_seca_descamativa" name="pele_perilesional_seca_descamativa" value="1">
                                <label for="pele_perilesional_seca_descamativa">Seca e Descamativa</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_eczematosa" name="pele_perilesional_eczematosa" value="1">
                                <label for="pele_perilesional_eczematosa">Eczematosa</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_hiperpigmentada" name="pele_perilesional_hiperpigmentada" value="1">
                                <label for="pele_perilesional_hiperpigmentada">Hiperpigmentada</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_hipopigmentada" name="pele_perilesional_hipopigmentada" value="1">
                                <label for="pele_perilesional_hipopigmentada">Hipopigmentada</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_indurada" name="pele_perilesional_indurada" value="1">
                                <label for="pele_perilesional_indurada">Indurada</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_sensivel" name="pele_perilesional_sensivel" value="1">
                                <label for="pele_perilesional_sensivel">Sensível</label>
                            </div>
                            <div class="checkbox-group" style="min-width: 180px;">
                                <input type="checkbox" id="pele_perilesional_edema" name="pele_perilesional_edema" value="1">
                                <label for="pele_perilesional_edema">Edema</label>
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

                <div class="step">

             
                <fieldset>
                    <legend>Informações Adicionais</legend>
                    <div class="input-group">
                        <label for="observacoes">Observações:</label>
                        <textarea id="observacoes" name="observacoes" placeholder="Observações adicionais"></textarea>
                    </div>
                    <div class="input-group">
                        <label for="data_consulta">Data da Consulta:</label>
                        <input type="date" id="data_consulta" name="data_consulta" required>
                    </div>
                    <div class="input-group">
                        <label for="hora_consulta">Hora da Consulta:</label>
                        <input type="time" id="hora_consulta" name="hora_consulta" required>
                    </div>
                    <div class="input-group">
                        <label for="profissional_responsavel">Profissional Responsável:</label>
                        <input type="text" id="profissional_responsavel" name="profissional_responsavel"
                            placeholder="Nome do profissional">
                    </div>
                    <div class="input-group">
                        <label for="coren">COREN/CRM:</label>
                        <input type="text" id="coren" name="coren" placeholder="COREN/CRM do profissional">
                    </div>
                    <div class="input-group">
                        <label for="assinatura">Assinatura do Profissional:</label>
                        <input type="file" id="assinatura" name="assinatura" accept="image/*" style="display:none;">
                        <button type="button" class="photo-button" id="abrir-assinatura">
                            <i class="fas fa-pen-nib"></i> Tirar/Selecionar Assinatura
                        </button>
                    </div>
                    <div class="photo-preview" style="margin-top:10px;">
                        <img id="assinatura-preview-img" src="" alt="Preview da assinatura"
                            style="display: none; max-width: 200px; border-radius: 8px;">
                        <p id="assinatura-preview-text" style="display: none;">Assinatura do profissional</p>
                        <button type="button" id="remover-assinatura" style="display:none; margin-top:5px;">Remover
                            Assinatura <i class="fas fa-times"></i></button>
                    </div>
                    <script src="/site/public/js/assinatura_script.js"> </script>
                    <div class="input-group">
                        <label for="data_atualizacao">Data de Atualização:</label>
                        <input type="date" id="data_atualizacao" name="data_atualizacao" required>
                    </div>
                </fieldset>
            </div>
            

            <div class="action-buttons">
                <button type="button" id="prevBtn"><i class="fas fa-arrow-left"></i> Voltar</button>
                <button type="button" id="nextBtn">Avançar <i class="fas fa-arrow-right"></i></button>
                <button type="submit" id="submitBtn">Salvar Anamnese <i class="fas fa-save"></i></button>
            </div>
        </form>
    </div>
    <div style="display: flex; justify-content: center; margin: 32px 0;">
        <a href="dashboard.html" class="back-to-dashboard-button" style="
            background: linear-gradient(90deg, #2563eb 0%, #60a5fa 100%);
            color: #fff;
            font-size: 1.13em;
            font-weight: 600;
            padding: 14px 36px;
            border-radius: 12px;
            box-shadow: 0 6px 24px rgba(37,99,235,0.13), 0 2px 8px rgba(0,0,0,0.08);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 50px;
            margin-top: -20px;
            transition: background 0.22s, box-shadow 0.22s, transform 0.18s;
            letter-spacing: 0.01em;
            border: none;
        " onmouseover="this.style.background='linear-gradient(90deg, #1e40af 0%, #2563eb 100%)';this.style.transform='translateY(-2px) scale(1.04)';this.style.boxShadow='0 10px 28px rgba(37,99,235,0.18)';"
        onmouseout="this.style.background='linear-gradient(90deg, #2563eb 0%, #60a5fa 100%)';this.style.transform='none';this.style.boxShadow='0 6px 24px rgba(37,99,235,0.13), 0 2px 8px rgba(0,0,0,0.08)';">
            <i class="fas fa-arrow-left" style="font-size: 1.2em;"></i>
            <span>Voltar ao Dashboard</span>
        </a>
    </div>
    <footer>
        <nav class="bottom-nav">
            <a href="dashboard.html" title="Home">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="agenda.html" title="Agenda">
                <i class="fas fa-calendar-alt"></i>
                <span>Agenda</span>
            </a>
            <a href="chat.html" title="Chat">
                <i class="fas fa-comment-dots"></i>
                <span>Chat</span>
            </a>
            <a href="profile.html" title="Perfil">
                <i class="fas fa-user-circle"></i>
                <span>Perfil</span>
            </a>
        </nav>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const steps = document.querySelectorAll('.step');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const progressBar = document.getElementById('progress-bar');
            const stepCounter = document.getElementById('step-counter');
            const anamneseForm = document.getElementById('anamnese-form');
            
            let currentStep = 0;

            const fotoFeridaInput = document.getElementById('foto_ferida');
            const larguraFeridaInput = document.querySelector('input[name="ferida_largura"]');
            const comprimentoFeridaInput = document.querySelector('input[name="ferida_comprimento"]');
            const profundidadeFeridaInput = document.querySelector('input[name="ferida_profundidade"]');

            // Function to display custom messages
            function showMessageBox(message, type) {
                const messageBox = document.createElement('div');
                messageBox.classList.add('message-box', type);
                messageBox.textContent = message;
                document.body.appendChild(messageBox);

                setTimeout(() => {
                    messageBox.style.opacity = 1;
                }, 10);

                setTimeout(() => {
                    messageBox.style.opacity = 0;
                    messageBox.addEventListener('transitionend', () => messageBox.remove());
                }, 3000);
            }

            function toggleTamanhoFeridaRequired() {
                if (fotoFeridaInput.files.length > 0) {
                    larguraFeridaInput.removeAttribute('required');
                    comprimentoFeridaInput.removeAttribute('required');
                    profundidadeFeridaInput.removeAttribute('required');
                } else {
                    larguraFeridaInput.setAttribute('required', '');
                    comprimentoFeridaInput.setAttribute('required', '');
                    profundidadeFeridaInput.setAttribute('required', '');
                }
            }

            function updateProgressBar() {
                const progress = ((currentStep + 1) / steps.length) * 100;
                progressBar.style.width = progress + '%';
            }

            function updateStepCounter() {
                stepCounter.textContent = `Tela ${currentStep + 1} de ${steps.length}`;
            }

            function showStep(n) {
                if (n < 0 || n >= steps.length) {
                    console.error(`Attempted to show invalid step: ${n}. Total steps: ${steps.length}`);
                    return;
                }

                steps.forEach(step => step.classList.remove('active'));
                document.querySelectorAll('[data-original-required]').forEach(field => {
                    field.removeAttribute('required');
                });

                steps[n].classList.add('active');
                currentStep = n;

                steps[n].querySelectorAll('[data-original-required]').forEach(field => {
                    field.setAttribute('required', '');
                });

                if (currentStep === 0) {
                    toggleTamanhoFeridaRequired();
                }

                updateProgressBar();
                updateStepCounter();

                if (currentStep === 0) {
                    prevBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'inline-block';
                }

                if (currentStep === steps.length - 1) {
                    nextBtn.style.display = 'none';
                    submitBtn.style.display = 'inline-block';
                } else {
                    nextBtn.style.display = 'inline-block';
                    submitBtn.style.display = 'none';
                }
            }

            // Store original 'required' state for all elements on load
            document.querySelectorAll('.step input[required], .step select[required], .step textarea[required]').forEach(field => {
                field.setAttribute('data-original-required', 'true');
            });

            prevBtn.addEventListener('click', () => {
                if (currentStep > 0) {
                    currentStep--;
                    window.scrollTo(0, 0);
                    showStep(currentStep);
                }
            });

            nextBtn.addEventListener('click', () => {
                const activeStep = steps[currentStep];
                const requiredFields = activeStep.querySelectorAll('input[required], select[required], textarea[required]');
                let allFieldsValid = true;
                let firstInvalidField = null;

                requiredFields.forEach(field => {
                    // Check if field is visible and not disabled, and if it's empty
                    if (!field.value.trim() && field.offsetParent !== null && !field.disabled) {
                        allFieldsValid = false;
                        field.classList.add('is-invalid');
                        if (!firstInvalidField) {
                            firstInvalidField = field;
                        }
                    } else {
                        field.classList.remove('is-invalid');
                    }
                });

                if (allFieldsValid) {
                    if (currentStep < steps.length - 1) {
                        currentStep++;
                        window.scrollTo(0, 0);
                        showStep(currentStep);
                    }
                } else {
                    showMessageBox('Por favor, preencha todos os campos obrigatórios nesta tela antes de avançar.', 'error');
                    if (firstInvalidField) {
                        firstInvalidField.focus();
                        firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });

            anamneseForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const formData = new FormData(anamneseForm);
                const data = {};

                // Process form data
                for (let [key, value] of formData.entries()) {
                    const inputElement = anamneseForm.querySelector(`[name="${key}"]`);
                    if (inputElement && inputElement.type === 'checkbox') {
                        data[key] = inputElement.checked ? 1 : 0;
                    } else {
                        data[key] = value;
                    }
                }

                // Handle hidden inputs that might not be in formData if they were hidden
                anamneseForm.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(input => {
                    if (input.id.endsWith('_nome') || input.id.endsWith('_dose') || input.id === 'qual_doenca' || input.id === 'qual_alergia' || input.id === 'qual_atividade' || input.id === 'frequencia_atividade' || input.id === 'frequencia_alcool' || input.id === 'localizacao_tunel_cavidade' || input.id === 'tipo_edema_perilesional' || input.id === 'controle_glicemico' || input.id === 'pulsos_perifericos' || input.id === 'etiologia_outra' || input.id === 'pele_perilesional_extensao' || input.id === 'outros_hpp' || input.id === 'outros_medicamento' || input.id === 'quantos_filhos' || input.id === 'quais_cirurgias') {
                        if (input.style.display === 'none') {
                            data[input.name] = ''; // Clear value if input is hidden
                        }
                    }
                });

                let storedAnamneses = JSON.parse(localStorage.getItem('anamneses')) || [];
                const editingIndex = localStorage.getItem('editingAnamneseIndex'); // Get index from localStorage

                try {
                    if (editingIndex !== null) {
                        // Editing existing anamnese
                        storedAnamneses[parseInt(editingIndex)] = data;
                        showMessageBox('Anamnese atualizada com sucesso!', 'success');
                    } else {
                        // Adding new anamnese
                        storedAnamneses.push(data);
                        showMessageBox('Anamnese salva com sucesso!', 'success');
                    }
                    localStorage.setItem('anamneses', JSON.stringify(storedAnamneses));

                    // Clear temporary data used for editing
                    localStorage.removeItem('editingAnamneseData');
                    localStorage.removeItem('editingAnamneseIndex');
                    
                    // Redirect back to dashboard with a success message
                    const encodedMessage = encodeURIComponent('Anamnese salva/atualizada com sucesso!');
                    window.location.href = `dashboard.html?messageType=success&messageText=${encodedMessage}`;

                } catch (error) {
                    console.error('Erro ao salvar/atualizar anamnese:', error);
                    const encodedError = encodeURIComponent(`Erro ao salvar/atualizar anamnese: ${error.message}`);
                    window.location.href = `dashboard.html?messageType=error&messageText=${encodedError}`;
                }
            });

            fotoFeridaInput.addEventListener('change', toggleTamanhoFeridaRequired);
            
            // Initial call to set required fields for the first step and show it
            showStep(currentStep);

            // Conditional display for form fields (copied from your original script)
            document.getElementById('diabetes').addEventListener('change', function () {
                document.getElementById('controle_glicemico_group').style.display = this.value === '1' ? 'block' : 'none';
            });
            const etiologiaSelect = document.getElementById('etiologia_ferida');
            const outraEtiologiaInput = document.getElementById('etiologia_outra');
            etiologiaSelect.addEventListener('change', function () {
                outraEtiologiaInput.style.display = this.value === 'outra' ? 'block' : 'none';
            });
            const doencaVascularCheckbox = document.getElementById('doenca_vascular');
            const funcaoVascularGroup = document.getElementById('funcao_vascular_group');
            doencaVascularCheckbox.addEventListener('change', function () {
                funcaoVascularGroup.style.display = this.checked ? 'block' : 'none';
            });

            const possuiDoencaSelect = document.getElementById('possui_doenca');
            possuiDoencaSelect.addEventListener('change', function () {
                const temDoenca = this.value === '1';
                const doencaText = document.getElementById('qual_doenca');
                doencaText.style.display = temDoenca ? 'block' : 'none';
                if (!temDoenca) {
                    doencaText.value = '';
                }
            });
            const usaMedicacaoSelect = document.getElementById('usa_medicacao');
            const qualMedicacaoInput = document.getElementById('qual_medicacao');
            usaMedicacaoSelect.addEventListener('change', function () {
                qualMedicacaoInput.style.display = this.value === '1' ? 'block' : 'none';
                if (this.value !== '1') {
                    qualMedicacaoInput.value = '';
                }
            });
            const possuiAlergiaSelect = document.getElementById('possui_alergia');
            const qualAlergiaInput = document.getElementById('qual_alergia');
            possuiAlergiaSelect.addEventListener('change', function () {
                qualAlergiaInput.style.display = this.value === '1' ? 'block' : 'none';
                if (this.value !== '1') {
                    qualAlergiaInput.value = '';
                }
            });
            const praticaAtividadeFisicaSelect = document.getElementById('pratica_atividade_fisica');
            const qualAtividadeInput = document.getElementById('qual_atividade');
            const frequenciaAtividadeInput = document.getElementById('frequencia_atividade');
            praticaAtividadeFisicaSelect.addEventListener('change', function () {
                const pratica = this.value === '1';
                qualAtividadeInput.style.display = pratica ? 'block' : 'none';
                frequenciaAtividadeInput.style.display = pratica ? 'block' : 'none';
                if (!pratica) {
                    qualAtividadeInput.value = '';
                    frequenciaAtividadeInput.value = '';
                }
            });
            const ingestaAlcoolSelect = document.getElementById('ingestao_alcool');
            const frequenciaAlcoolInput = document.getElementById('frequencia_alcool');
            ingestaAlcoolSelect.addEventListener('change', function () {
                frequenciaAlcoolInput.style.display = this.value === '1' ? 'block' : 'none';
                if (this.value !== '1') {
                    frequenciaAlcoolInput.value = ''; // Corrected variable name
                }
            });

            // Populate form if in edit mode
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('mode') === 'edit') {
                const editingAnamneseData = JSON.parse(localStorage.getItem('editingAnamneseData'));
                if (editingAnamneseData) {
                    document.querySelector('h1').textContent = 'Editar Anamnese';
                    for (const key in editingAnamneseData) {
                        const input = anamneseForm.elements[key];
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = editingAnamneseData[key] === 1;
                            } else {
                                input.value = editingAnamneseData[key];
                            }
                            // Trigger change event for dynamic fields
                            if (input.tagName === 'SELECT' || input.type === 'checkbox') {
                                input.dispatchEvent(new Event('change'));
                            }
                        }
                    }
                    // Special handling for text inputs associated with checkboxes
                    anamneseForm.querySelectorAll('.checkbox-group input[type="checkbox"]').forEach(checkbox => {
                        const associatedInputName = checkbox.name + '_nome' || checkbox.name + '_dose';
                        const associatedInput = anamneseForm.elements[associatedInputName];
                        if (associatedInput) {
                            if (checkbox.checked && editingAnamneseData[associatedInputName]) {
                                associatedInput.value = editingAnamneseData[associatedInputName];
                                associatedInput.style.display = 'block'; // Ensure it's visible
                            } else {
                                associatedInput.style.display = 'none'; // Ensure it's hidden if checkbox not checked
                            }
                        }
                    });

                } else {
                    showMessageBox('Erro: Dados da anamnese para edição não encontrados.', 'error');
                }
            } else {
                 // For new anamnese, clear any lingering editing data
                 localStorage.removeItem('editingAnamneseData');
                 localStorage.removeItem('editingAnamneseIndex');
            }
        });
    </script>
</body>

</html>